name: AWS S3 Upload

on:
  workflow_call:
    inputs:
      environment:
        description: Deployment environment (e.g. PROD, STG, QA, DEV)
        required: false
        type: string
        default: DEV
      aws-region:
        description: AWS region to use for S3 operations
        required: false
        type: string
        default: us-east-1
      aws-role-to-assume:
        description: AWS IAM Role to assume for S3 access
        required: false
        type: string
      aws-role-session-name:
        description: AWS IAM Role session name
        required: false
        type: string
        default: github-actions-session
      aws-role-duration-seconds:
        description: Duration in seconds for the assumed role session
        required: false
        type: number
        default: 900
      s3-bucket:
        description: Name of the S3 bucket to upload to (overrides default bucket)
        required: true
        type: string
      s3-prefix:
        description: S3 key prefix (folder path)
        required: false
        type: string
      artifact-name:
        description: Name of the artifact to download
        required: true
        type: string
      artifact-path:
        description: Path where the artifact will be downloaded
        required: false
        type: string
        default: ./artifact
      run-id:
        description: The run ID of the workflow that generated the artifact
        required: false
        type: string
    secrets:
      aws-access-key-id:
        description: AWS Access Key ID
        required: false
      aws-secret-access-key:
        description: AWS Secret Access Key
        required: false
    outputs:
      s3-uri:
        description: The S3 URI where files were uploaded
        value: ${{ jobs.upload.outputs.s3-uri }}
      files-uploaded:
        description: Number of files uploaded
        value: ${{ jobs.upload.outputs.files-uploaded }}

jobs:
  s3-upload:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      s3-uri: ${{ steps.upload.outputs.s3-uri }}
      files-uploaded: ${{ steps.upload.outputs.files-uploaded }}

    steps:
      # - name: Checkout
      #   uses: actions/checkout@v6

      - name: Download Artifact (from current workflow)
        if: ${{ inputs.run-id == '' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}

      - name: Download Artifact (from specific run)
        if: ${{ inputs.run-id != '' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run-id }}

      - name: List Downloaded Files
        run: |
          echo ðŸ“¦ Downloaded artifact contents:
          ls -laR ${{ inputs.artifact-path }}
          echo 
          FILE_COUNT=$(find ${{ inputs.artifact-path }} -type f | wc -l)
          echo ðŸ“Š Total files: $FILE_COUNT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-assume }}
          role-session-name: ${{ inputs.aws-role-session-name }}
          role-duration-seconds: ${{ inputs.aws-role-duration-seconds }}

      - name: Upload to S3
        id: upload
        run: |
          echo ðŸš€ Uploading to S3...
          
          # Build S3 destination URI
          S3_BUCKET="${{ inputs.s3-bucket }}"
          S3_PREFIX="${{ inputs.s3-prefix }}"
          
          if [ -n "$S3_PREFIX" ]; then
            S3_URI="s3://${S3_BUCKET}/${S3_PREFIX}"
          else
            S3_URI="s3://${S3_BUCKET}"
          fi
          
          echo "s3-uri=${S3_URI}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Destination: $S3_URI"
          
          # Count files before upload
          FILE_COUNT=$(find ${{ inputs.artifact-path }} -type f | wc -l)
          echo "files-uploaded=${FILE_COUNT}" >> $GITHUB_OUTPUT
          
          # Execute upload using sync
          echo "ðŸ“¤ Uploading files..."
          aws s3 sync "${{ inputs.artifact-path }}" "$S3_URI" 
          
          echo "âœ… Upload completed successfully"

      - name: Verify Upload
        run: |
          echo "ðŸ” Verifying uploaded files..."
          
          S3_URI="${{ steps.upload.outputs.s3-uri }}"
          
          echo "ðŸ“ Files in $S3_URI:"
          aws s3 ls $S3_URI --recursive --human-readable | head -20
          
          UPLOADED_COUNT=$(aws s3 ls $S3_URI --recursive | wc -l)
          echo 
          echo "ðŸ“Š Total files in S3: $UPLOADED_COUNT"
      
      - name: Summary
        run: |
          echo "## ðŸ“¦ S3 Upload Summary" >> $GITHUB_STEP_SUMMARY
          echo  "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | ${{ inputs.s3-bucket }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 URI** | ${{ steps.upload.outputs.s3-uri }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Files Uploaded** | ${{ steps.upload.outputs.files-uploaded }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | ${{ inputs.artifact-name }} |" >> $GITHUB_STEP_SUMMARY
          echo  "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Upload completed successfully!" >> $GITHUB_STEP_SUMMARY
