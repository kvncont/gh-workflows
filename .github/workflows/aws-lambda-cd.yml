name: AWS Lambda CD

on:
  workflow_call:
    inputs:
      environment:
        description: Deployment environment (e.g. PROD, STG, QA, DEV)
        required: false
        type: string
        default: DEV
      aws-region:
        description: AWS region to use for Lambda operations
        required: false
        type: string
        default: us-east-1
      aws-role-to-assume:
        description: AWS IAM Role to assume for Lambda access
        required: false
        type: string
      aws-role-session-name:
        description: AWS IAM Role session name
        required: false
        type: string
        default: github-actions-session
      aws-role-duration-seconds:
        description: Duration in seconds for the assumed role session
        required: false
        type: number
        default: 900
      lambda-name:
        description: Name of the AWS Lambda function to deploy
        required: true
        type: string
      artifact-name:
        description: Name of the GitHub artifact to download (when artifact-source is 'github')
        required: false
        type: string
      run-id:
        description: The run ID of the workflow that generated the artifact
        required: false
        type: string
      artifact-path:
        description: Path where the artifact will be downloaded
        required: false
        type: string
        default: ./artifact
      zip-file:
        description: Name of the ZIP file containing the Lambda code
        required: true
        type: string
      env-file:
        description: Path to the environment variables file (JSON format)
        required: false
        type: string
      publish-version:
        description: Whether to publish a new version of the Lambda
        required: false
        type: boolean
        default: true
      version-description:
        description: Description for the new Lambda version
        required: false
        type: string
        default: Deployed via GitHub Actions
      lambda-alias:
        description: Alias name to update with the new version
        required: false
        type: string
        default: stable
    secrets:
      aws-access-key-id:
        description: AWS Access Key ID
        required: true
      aws-secret-access-key:
        description: AWS Secret Access Key
        required: true
    outputs:
      lambda-version:
        description: The published Lambda version number
        value: ${{ jobs.deploy-lambda.outputs.lambda-version }}
      function-arn:
        description: The ARN of the updated Lambda function
        value: ${{ jobs.deploy-lambda.outputs.function-arn }}
      s3-uri:
        description: The S3 URI from where artifact was downloaded (when using S3)
        value: ${{ jobs.deploy-lambda.outputs.s3-uri }}

jobs:
  deploy-lambda:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      lambda-version: ${{ steps.publish-version.outputs.version }}
      function-arn: ${{ steps.update-code.outputs.function-arn }}
      s3-uri: ${{ steps.download-s3.outputs.s3-uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Artifact from GitHub (current workflow)
        if: ${{ inputs.run-id == '' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}

      - name: Download Artifact from GitHub (specific run)
        if: ${{ inputs.run-id != '' }}
        uses: actions/download-artifact@v6  
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run-id }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.aws-role-to-assume }}
          role-session-name: ${{ inputs.aws-role-session-name }}
          role-duration-seconds: ${{ inputs.aws-role-duration-seconds }}

      - name: Update Lambda Code
        id: update-code
        run: |
          echo "ðŸš€ Updating Lambda function code: ${{ inputs.lambda-name }}"
          
          ZIP_PATH="${{ inputs.artifact-path }}/${{ inputs.zip-file }}"
          
          if [ ! -f "$ZIP_PATH" ]; then
            echo "âŒ Error: ZIP file not found at $ZIP_PATH"
            exit 1
          fi
          
          RESULT=$(aws lambda update-function-code \
            --function-name ${{ inputs.lambda-name }} \
            --zip-file fileb://$ZIP_PATH \
            --output json)
          
          FUNCTION_ARN=$(echo $RESULT | jq -r '.FunctionArn')
          echo "function-arn=$FUNCTION_ARN" >> $GITHUB_OUTPUT
          echo "âœ… Lambda code updated successfully"
          echo "ðŸ“ Function ARN: $FUNCTION_ARN"

      - name: Wait for Lambda Update
        run: |
          echo "â³ Waiting for Lambda function to be ready..."
          aws lambda wait function-updated \
            --function-name ${{ inputs.lambda-name }}
          echo "âœ… Lambda function is ready"

      - name: Update Environment Variables
        if: ${{ inputs.env-file != '' }}
        run: |
          echo "ðŸ”§ Updating environment variables from: ${{ inputs.env-file }}"
          
          ENV_FILE_PATH="${{ inputs.env-file }}"
          
          if [ ! -f "$ENV_FILE_PATH" ]; then
            echo "âŒ Error: Environment file not found at $ENV_FILE_PATH"
            exit 1
          fi
          
          # Read environment variables from JSON file
          ENV_VARS=$(cat "$ENV_FILE_PATH")
          
          # Validate JSON format
          if ! echo "$ENV_VARS" | jq . > /dev/null 2>&1; then
            echo "âŒ Error: Invalid JSON format in environment file"
            exit 1
          fi
          
          # Update Lambda environment variables
          aws lambda update-function-configuration \
            --function-name ${{ inputs.lambda-name }} \
            --environment file://$ENV_FILE_PATH
          
          echo "âœ… Environment variables updated successfully"

      - name: Wait for Configuration Update
        if: ${{ inputs.env-file != '' }}
        run: |
          echo "â³ Waiting for Lambda configuration to be ready..."
          aws lambda wait function-updated \
            --function-name ${{ inputs.lambda-name }}
          echo "âœ… Lambda configuration is ready"

      - name: Publish Lambda Version
        id: publish-version
        if: ${{ inputs.publish-version }}
        run: |
          echo "ðŸ“Œ Publishing new Lambda version..."
          
          RESULT=$(aws lambda publish-version \
            --function-name ${{ inputs.lambda-name }} \
            --description "${{ inputs.version-description }}" \
            --output json)
          
          VERSION=$(echo $RESULT | jq -r '.Version')
          VERSION_ARN=$(echo $RESULT | jq -r '.FunctionArn')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Published Lambda version: $VERSION"
          echo "ðŸ“ Version ARN: $VERSION_ARN"

      - name: Update Lambda Alias
        if: ${{ inputs.publish-version && inputs.lambda-alias != '' }}
        run: |
          echo "ðŸ·ï¸ Updating alias '${{ inputs.lambda-alias }}' to version ${{ steps.publish-version.outputs.version }}..."
          
          VERSION="${{ steps.publish-version.outputs.version }}"
          ALIAS="${{ inputs.lambda-alias }}"
          
          # Check if alias exists
          if aws lambda get-alias \
            --function-name ${{ inputs.lambda-name }} \
            --name "$ALIAS" > /dev/null 2>&1; then
            
            # Update existing alias
            aws lambda update-alias \
              --function-name ${{ inputs.lambda-name }} \
              --name "$ALIAS" \
              --function-version "$VERSION" \
              --description "Updated via GitHub Actions"
            
            echo "âœ… Alias '$ALIAS' updated to version $VERSION"
          else
            # Create new alias
            aws lambda create-alias \
              --function-name ${{ inputs.lambda-name }} \
              --name "$ALIAS" \
              --function-version "$VERSION" \
              --description "Created via GitHub Actions"
            
            echo "âœ… Alias '$ALIAS' created pointing to version $VERSION"
          fi

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Lambda Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Lambda Name** | ${{ inputs.lambda-name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ inputs.aws-region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact Source** | ${{ inputs.artifact-source }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.artifact-source }}" == "s3" ]; then
            echo "| **S3 URI** | ${{ steps.download-s3.outputs.s3-uri }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Artifact Name** | ${{ inputs.artifact-name }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.publish-version }}" == "true" ]; then
            echo "| **Version** | ${{ steps.publish-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.publish-version }}" == "true" ] && [ -n "${{ inputs.lambda-alias }}" ]; then
            echo "| **Alias** | ${{ inputs.lambda-alias }} â†’ v${{ steps.publish-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.env-file }}" ]; then
            echo "| **Env File** | ${{ inputs.env-file }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
