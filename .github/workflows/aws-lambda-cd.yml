name: AWS Lambda CD

on:
  workflow_call:
    inputs:
      environment:
        description: Deployment environment (e.g. PROD, STG, QA, DEV)
        required: false
        type: string
        default: DEV
      
      # Artifact source configuration
      artifact-source:
        description: "Source of the artifact: 's3' or 'github'"
        required: false
        type: string
        default: github
      
      # GitHub Artifact inputs
      artifact-name:
        description: Name of the GitHub artifact to download (when artifact-source is 'github')
        required: false
        type: string
      run-id:
        description: The run ID of the workflow that generated the artifact
        required: false
        type: string
      
      # S3 Artifact inputs
      s3-prefix:
        description: S3 key prefix (folder path)
        required: false
        type: string
      
      # Common inputs
      artifact-path:
        description: Path where the artifact will be downloaded
        required: false
        type: string
        default: ./artifact
      zip-file:
        description: Name of the ZIP file containing the Lambda code
        required: true
        type: string
      env-file:
        description: Path to the environment variables file (JSON format)
        required: false
        type: string
      publish-version:
        description: Whether to publish a new version of the Lambda
        required: false
        type: boolean
        default: true
      version-description:
        description: Description for the new Lambda version
        required: false
        type: string
        default: Deployed via GitHub Actions
    secrets:
      aws-access-key-id:
        description: AWS Access Key ID
        required: false
      aws-secret-access-key:
        description: AWS Secret Access Key
        required: false
    outputs:
      lambda-version:
        description: The published Lambda version number
        value: ${{ jobs.deploy.outputs.lambda-version }}
      function-arn:
        description: The ARN of the updated Lambda function
        value: ${{ jobs.deploy.outputs.function-arn }}
      s3-uri:
        description: The S3 URI from where artifact was downloaded (when using S3)
        value: ${{ jobs.deploy.outputs.s3-uri }}

jobs:
  deploy-lambda:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      lambda-version: ${{ steps.publish-version.outputs.version }}
      function-arn: ${{ steps.update-code.outputs.function-arn }}
      s3-uri: ${{ steps.download-s3.outputs.s3-uri }}

    steps:
      # GitHub Artifact Download
      - name: Download Artifact from GitHub (current workflow)
        if: ${{ inputs.artifact-source == 'github' && inputs.run-id == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}

      - name: Download Artifact from GitHub (specific run)
        if: ${{ inputs.artifact-source == 'github' && inputs.run-id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          github-token: ${{ github.token }}
          run-id: ${{ inputs.run-id }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          role-session-name: ${{ vars.AWS_ROLE_SESSION_NAME }}
          role-duration-seconds: ${{ vars.AWS_ROLE_DURATION_SECONDS }}

      # S3 Artifact Download
      - name: Download Artifact from S3
        id: download-s3
        if: ${{ inputs.artifact-source == 's3' }}
        run: |
          echo "ðŸ“¥ Downloading from S3..."
          
          # Build S3 URI
          S3_BUCKET="${{ vars.AWS_S3_BUCKET }}"
          S3_PREFIX="${{ inputs.s3-prefix }}"
          ZIP_FILE="${{ inputs.zip-file }}"
          
          if [ -n "$S3_PREFIX" ]; then
            S3_URI="s3://${S3_BUCKET}/${S3_PREFIX}/${ZIP_FILE}"
          else
            S3_URI="s3://${S3_BUCKET}/${ZIP_FILE}"
          fi
          
          echo "s3-uri=${S3_URI}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Source: $S3_URI"
          
          # Create download directory and download
          mkdir -p ${{ inputs.artifact-path }}
          aws s3 cp "$S3_URI" "${{ inputs.artifact-path }}/"
          
          echo "âœ… Download from S3 completed"

      - name: List Downloaded Files
        run: |
          echo "ðŸ“¦ Downloaded artifact contents:"
          ls -la ${{ inputs.artifact-path }}

      - name: Update Lambda Code
        id: update-code
        run: |
          echo "ðŸš€ Updating Lambda function code: ${{ vars.AWS_LAMBDA_NAME }}"
          
          ZIP_PATH="${{ inputs.artifact-path }}/${{ inputs.zip-file }}"
          
          if [ ! -f "$ZIP_PATH" ]; then
            echo "âŒ Error: ZIP file not found at $ZIP_PATH"
            exit 1
          fi
          
          RESULT=$(aws lambda update-function-code \
            --function-name ${{ vars.AWS_LAMBDA_NAME }} \
            --zip-file fileb://$ZIP_PATH \
            --output json)
          
          FUNCTION_ARN=$(echo $RESULT | jq -r '.FunctionArn')
          echo "function-arn=$FUNCTION_ARN" >> $GITHUB_OUTPUT
          echo "âœ… Lambda code updated successfully"
          echo "ðŸ“ Function ARN: $FUNCTION_ARN"

      - name: Wait for Lambda Update
        run: |
          echo "â³ Waiting for Lambda function to be ready..."
          aws lambda wait function-updated \
            --function-name ${{ vars.AWS_LAMBDA_NAME }}
          echo "âœ… Lambda function is ready"

      - name: Update Environment Variables
        if: ${{ inputs.env-file != '' }}
        run: |
          echo "ðŸ”§ Updating environment variables from: ${{ inputs.env-file }}"
          
          if [ ! -f "${{ inputs.env-file }}" ]; then
            echo "âŒ Error: Environment file not found at ${{ inputs.env-file }}"
            exit 1
          fi
          
          # Read environment variables from JSON file
          ENV_VARS=$(cat ${{ inputs.env-file }})
          
          # Validate JSON format
          if ! echo "$ENV_VARS" | jq . > /dev/null 2>&1; then
            echo "âŒ Error: Invalid JSON format in environment file"
            exit 1
          fi
          
          # Update Lambda environment variables
          aws lambda update-function-configuration \
            --function-name ${{ vars.AWS_LAMBDA_NAME }} \
            --environment "Variables=$ENV_VARS"
          
          echo "âœ… Environment variables updated successfully"

      - name: Wait for Configuration Update
        if: ${{ inputs.env-file != '' }}
        run: |
          echo "â³ Waiting for Lambda configuration to be ready..."
          aws lambda wait function-updated \
            --function-name ${{ vars.AWS_LAMBDA_NAME }}
          echo "âœ… Lambda configuration is ready"

      - name: Publish Lambda Version
        id: publish-version
        if: ${{ inputs.publish-version }}
        run: |
          echo "ðŸ“Œ Publishing new Lambda version..."
          
          RESULT=$(aws lambda publish-version \
            --function-name ${{ vars.AWS_LAMBDA_NAME }} \
            --description "${{ inputs.version-description }}" \
            --output json)
          
          VERSION=$(echo $RESULT | jq -r '.Version')
          VERSION_ARN=$(echo $RESULT | jq -r '.FunctionArn')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Published Lambda version: $VERSION"
          echo "ðŸ“ Version ARN: $VERSION_ARN"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Lambda Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Lambda Name** | ${{ vars.AWS_LAMBDA_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ vars.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact Source** | ${{ inputs.artifact-source }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.artifact-source }}" == "s3" ]; then
            echo "| **S3 URI** | ${{ steps.download-s3.outputs.s3-uri }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Artifact Name** | ${{ inputs.artifact-name }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.publish-version }}" == "true" ]; then
            echo "| **Version** | ${{ steps.publish-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.env-file }}" ]; then
            echo "| **Env File** | ${{ inputs.env-file }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
